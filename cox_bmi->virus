library(survival)
library(dplyr)
library(purrr)
library(ggplot2)

## 1. Identify all serology outcomes to model (columns ending in "_sero")
outcome_vars <- names(processed_list[[1]])[grepl("_sero$", names(processed_list[[1]]))]
outcome_vars
# e.g. c("CMV_class_sero", "cut_VZV_sero", ...)

## 2. Function to fit Cox model for a given outcome across all imputations
fit_cox_for_outcome <- function(outcome_name, data_list) {
  # For each imputed dataset, fit Surv(age, outcome) ~ bmi_scaled + sex + coh
  lapply(data_list, function(df) {
    # make sure outcome is numeric 0/1; Surv will ignore NAs automatically
    coxph(Surv(age, df[[outcome_name]]) ~ bmi_scaled + sex + coh, data = df)
  })
}

## 3. Rubin pooling for bmi_scaled coefficient from a list of Cox models
pool_bmi_scaled <- function(cox_list, outcome_name) {
  # Extract beta and variance for bmi_scaled
  beta_vec <- sapply(cox_list, function(fit) {
    coef(fit)[["bmi_scaled"]]
  })
  var_vec <- sapply(cox_list, function(fit) {
    vcov(fit)["bmi_scaled", "bmi_scaled"]
  })
  
  # Drop fits where bmi_scaled is NA (e.g. no events or separation)
  keep <- !is.na(beta_vec) & !is.na(var_vec)
  beta_vec <- beta_vec[keep]
  var_vec  <- var_vec[keep]
  m <- length(beta_vec)
  
  if (m <= 1) {
    return(
      data.frame(
        outcome   = outcome_name,
        term      = "bmi_scaled",
        beta      = NA_real_,
        se        = NA_real_,
        df        = NA_real_,
        HR        = NA_real_,
        CI_lower  = NA_real_,
        CI_upper  = NA_real_,
        t_value   = NA_real_,
        p_value   = NA_real_
      )
    )
  }
  
  # Rubin's rules
  Q_bar <- mean(beta_vec)           # pooled beta
  W     <- mean(var_vec)            # within-imputation variance
  B     <- var(beta_vec)            # between-imputation variance
  T_var <- W + (1 + 1/m) * B        # total variance
  se    <- sqrt(T_var)              # pooled SE
  
  # Barnardâ€“Rubin degrees of freedom
  df <- (m - 1) * (1 + W / ((1 + 1/m) * B))^2
  
  # tests
  t_val <- Q_bar / se
  p_val <- 2 * pt(-abs(t_val), df = df)
  
  # HR and 95% CI
  HR    <- exp(Q_bar)
  lower <- exp(Q_bar - qt(0.975, df) * se)
  upper <- exp(Q_bar + qt(0.975, df) * se)
  
  data.frame(
    outcome   = outcome_name,
    term      = "bmi_scaled",
    beta      = Q_bar,
    se        = se,
    df        = df,
    HR        = HR,
    CI_lower  = lower,
    CI_upper  = upper,
    t_value   = t_val,
    p_value   = p_val
  )
}

## 4. Fit Cox models for all outcomes across imputations
cox_lists_all <- lapply(outcome_vars, fit_cox_for_outcome, data_list = processed_list)
names(cox_lists_all) <- outcome_vars

## 5. Pool results for bmi_scaled across imputations for each outcome
pooled_results_bmi_scaled <- bind_rows(
  Map(pool_bmi_scaled, cox_lists_all, outcome_vars)
)

pooled_results_bmi_scaled
# outcome-specific HRs of bmi_scaled, with CI and p-values

## 6. Forest plot: pooled HR(bmi_scaled) for each serology outcome
ggplot(
  pooled_results_bmi_scaled %>% filter(!is.na(HR)),
  aes(x = outcome, y = HR)
) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper), width = 0.15) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  theme_minimal() +
  labs(
    title = "Pooled HR of bmi_scaled for each serology outcome",
    x = "Serology outcome",
    y = "Hazard Ratio (bmi_scaled)"
  )

## 7. Optional: show HR(bmi_scaled) across imputations for each outcome (spaghetti/facet plot)
hr_long <- bind_rows(
  lapply(seq_along(outcome_vars), function(j) {
    out_name <- outcome_vars[j]
    cox_list <- cox_lists_all[[j]]
    hr_each  <- sapply(cox_list, function(fit) exp(coef(fit)[["bmi_scaled"]]))
    data.frame(
      outcome = out_name,
      imp     = seq_along(hr_each),
      HR      = hr_each
    )
  })
)

ggplot(hr_long %>% filter(!is.na(HR)),
       aes(x = imp, y = HR, group = outcome, colour = outcome)) +
  geom_line(alpha = 0.4) +
  geom_point() +
  theme_minimal() +
  labs(
    title = "HR(bmi_scaled) across imputations for each serology outcome",
    x = "Imputation index",
    y = "Hazard Ratio"
  )

This is the end of the explanation.
::contentReference[oaicite:0]{index=0}
